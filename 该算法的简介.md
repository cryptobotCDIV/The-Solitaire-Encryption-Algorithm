# The-Solitaire-Encryption-Algorithm
Designed by Bruce Schneier Featured in Neal Stephenson's Cryptonomicon
这是一种不需要借助计算机只靠一副扑克牌就能执行加密解密操作的流密码，但是却有着比较高的安全性。

[原文链接](https://www.schneier.com/academic/solitaire/)
在Neal Stephenson的小说“Cryptonomicon”中，角色Enoch Root给另一个角色Randy Waterhouse描述了一个代号为“Pontifex”的密码系统，其中算法的步骤是用一副扑克牌进行的。 这两个角色在小说中继续使用此系统交换多个加密消息。 该系统被称为“Solitaire”（在小说中，“Pontifex”是一个代码名称，旨在暂时隐瞒它使用一副纸牌的事实）我设计它以允许两个人安全地进行通信，而不必依赖电子或必须携带可能会被怀疑有罪的工具。 有时候想要交换加密信息的两个人可能处于无法访问计算机，或者如果他有秘密通信工具可能会被起诉的状况。 但是一副纸牌......这有什么害处？

Solitaire从一副洗好的扑克牌里面的固有随机性中获得了安全性。 通过操作这个套牌，通信者可以创建一串“随机”字母，然后将其与他的消息结合起来。 当然，Solitaire可以在计算机上模拟，但它的设计是让使用者可以手工实现的。

使用Solitaire进行信息加密是不需要什么高科技的，但其安全性确实可以抵御高科技的。 我设计的这个算法是安全的，即使是面对资金最充足的，拥有大型计算机和聪明密码分析专家的军事对手。 当然，不能保证有人不会找到一个聪明的针对Solitaire的攻击手段，但算法肯定比我见过的任何其他手写密码(即其操作手段可以简单到不需要借助于计算机)更好。

但这个加密的过程并不快。 加密或解密相当长的消息可能需要一个晚上。 在David Kahn的书“Kahn on Codes”中，他描述了苏联间谍使用的真正的铅笔纸密码。 苏联算法和Solitaire都需要大约相同的时间来加密消息：差不多一整个晚上。

###  **Solitaire的加密过程**
使用该算法加密Stephenson的小说中的这句“不要使用PC”作为第一条Solitaire加密信息。

1.将明文以五个字母一组的形式分组。 （五个字符一组没有什么神奇之处;这只是传统而已。）使用X来填充最后一组。 因此，如果消息是“不要使用PC”，那么明文是：

**DONOT  USEPC**

2.使用Solitaire生成十个密钥流字母。 （如何生成下文会提到。）假设它们是：

**KDWUP  ONOWT**

3.将明文消息从字母转换为数字，A = 1，B = 2等：

**4 15 14 15 20   21 19 5 16 3**

4.类似地转换密钥流字母为数字：

**11 4 23 21 16   15 14 15 23 20**

5.将明文数字流与密钥数字流用模26的加法相加（所有这些意味着，如果总和大于26，则从结果中减去26）。例如，1 + 1 = 2,26 + 1 = 27 ，27-26 = 1，所以26 + 1 = 1（mod 26）。于是得到：

**15 19 11 10 10   10 7 20 13 23**

6.将数字转换回字母。

**OSKJJ  JGTMW**

如果你真的很擅长这个，你可以学习在脑中字母顺序模26的加法。只要经过练习这并不困难，比如很容易记住A + A = B; 记住T + Q = K稍微困难一点。
###  **Solitaire的解密过程**
基本思想是接收器生成相同的密钥流，然后从密文字母中减去（模26的减法）密钥流字母。（即与加密过程互逆的操作）

1.获取密文消息并将其放入五个字符的组中。 （它应该已经是这种形式了。）
**OSKJJ  JGTMW**

2.使用Solitaire生成十个密钥流字母。 如果接收方使用与发送方相同的密钥，则密钥流字母将相同：
**KDWUP  ONOWT**
3.将密文消息从字母转换为数字：
**15 19 11 10 10   10 7 20 13 23**
4.类似地转换密钥流字母：
**11 4 23 21 16   15 14 15 23 20**
5.从密文数中减去密钥流数，模数为26.例如，22-1 = 21,1-2 = 25。 （1-2=-1，-1+26=25 因为做模的运算总是除26的正的余数。-1相当于26k-1，那么相当于26(k-1)+26-1=26(k-1)+25）
**4 15 14 15 20   21 19 5 16 3**
6.将运算得到的数字转换回字母。
**DONOT  USEPC**

如您所见，解密与加密过程几乎是相同的，只是您从密文消息中减去密钥流。

### **如何生成密钥流**
如何生成密钥流这是Solitaire的核心。 以上对加密和解密的描述适用于任何输出反馈模式流密码。 这是RC4的工作方式。 这是DES工作的OFB模式。 本节特定于Solitaire，并解释了Solitaire如何生成这些密钥流字母。

Solitaire使用一副扑克生成其密钥流。 你可以把54张卡牌（记住两个小丑）想象成一个54元素的排列。 有54！，或大约2.31 * 10 ^ 71种，可能是的不同排序。 更好的是，一副牌中有52张牌（没有大小王），字母表中有26张牌。 这种巧合太好了，不能错过。（52=26*2）

为了使用Solitaire，需要一整套52张牌和两个小丑的扑克。 这小丑必须是在某种程度上必须是不同的（大小王）。 （这很常见。在我写这篇文章的时候我正在看我手上这张牌组的小丑：一个有一个小星星，另一个有一个大星星。） 如果两张大小丑一样，你可以在两张小丑上做标记，例如在一张上写一个大“A”和“B”，但请记住，如果你被抓住，你将不得不向秘密警察解释。（可以解释为打牌需要，大王>小王的牌局规则）

请拿起手中的牌，面朝上。 然后将卡片叠好成一摞作为密钥的初始配置。 （我稍后会谈到密钥，但它与密钥流不同。）现在，您已准备好生成一串密钥流字母。

以下是如何生成单个输出字符：

1.**找到小丑A。 向下移动一张卡片** 。（也就是说，将它与下面的卡交换。）如果小丑是牌组的底牌，请将其移到顶牌下方。(也就是把小丑A换到前位置下一张牌的下面，但如果小丑A是最底部的牌那么当前位置下一张牌即为最顶部的牌，那么交换到它的下面即为顶部牌的下一张。把一副扑克视为一个循环的数组)
2.**找到小丑B。 向下移动两张牌**。 如果小丑是牌组的底牌，请将其移到第二张牌的正下方。 如果小丑是底牌的上一张牌，请将其移到顶部卡的正下方。 （基本上，假设牌组是一个循环......你明白了。)

按顺序执行这两个步骤非常重要。 这很容易适应，只是在找到它们然后按要求移动。 这很轻松，除非他们彼此非常接近。

因此，如果在第1步之前这副牌看起来像这样：
**A 7 2 B 9 4 1**
在第2步结束时它应该是：
**7 A 2 9 4 B 1**
如果在第1步之前这副牌看起来像这样：
**3 A B 8 9 6**
那么在第2步结束时它应该是：
**3 A 8 B 9 6**

3.**执行三重切牌**。 也就是说，将第一个小丑上方的所有牌与第二个小丑下面的所有牌交换。 如果这时候牌组是：
**2 4 6 B 5 8 7 1 A 3 9**
然后在三次割操作后，它应该是：
**3 9 B 5 8 7 1 A 2 4 6**

第一个“和”第二个“小丑指的是任何小丑最接近牌顶部和最接近牌底部的小丑，而不是小丑A，小丑B一开始的设定。

请记住，两张小丑之间的牌不要移动; 移动的是他们上面或者下面的那些卡片。 这很容易在你手中。 如果三个部分之一中有一个没有没有卡片（笑两张小丑相邻，或者一个在顶部或底部），只需将该部分视为空，然后移动它。 如果现在的卡组是：
**B 5 8 7 1 A 3 9**
那么三重切牌以后：
**3 9 B 5 8 7 1 A**

如果当前卡组是:
**B 5 8 7 1 A**
那么这一步不进行。(上下两部分都是空，空与空格交换仍然是空，等于没有改变)

4.**执行计数切牌**。 看现在这组牌的底卡。 将底牌其转换为1到53之间的数字。（使用桥牌顺序：梅花，钻石，红心和黑桃。如果这张牌是梅花，则就是其显示的值。如果牌是钻石那么是其牌面数值+13，如果它是一张红心，那么它是牌面值+26.如果它是一张黑桃，它的值则是牌面值+39。小丑是53.）从底牌开始向上数，数底牌大小的张数。比如底牌是9，那么向上数9张，假设第九张是4，那么4及其以上的卡片，以及底牌9到4之间的卡片进行交换。这就是计数切牌。注意不要把底牌切走，如果现在卡组是如下：

**7,... cards .. 4,5 ... cards ... 8,9**

那么执行计数切牌以后应该是：
**5,... cards ... 8,7... cards ... 4,9**

最后一张卡留在原位的原因是使步骤可逆。 这对于其安全性的数学分析很重要。通过这一步骤，以小丑为底牌的牌组将保持不变。注意从下向上计数的时候，请确保不要打乱当前牌组的顺序。 正确的计算方法是将卡片从一只手传递到另一只手。 不要在桌子上堆积，避免打乱顺序。


5.找到输出卡。 要执行此操作，请查看顶部卡片。 以与步骤4相同的方式将其转换为1到53之间的数字。从上向下数，数到顶部卡数值的位置的卡片。 （将顶部卡片计为第一位。）将您计算的卡片写在一张纸上; 不要将它从卡牌中上移除。 （如果你数到了一张小丑，不要写任何东西并重新开始步骤1.）这是第一张输出卡。 请注意，此步骤不会修改卡组的状态。（只记录输出值，不要切牌）

6.将输出卡转换为数字，数字在转化为字母。 和以前一样，使用桥牌的规矩来排大小。 从最低到最高，我们有梅花，钻石，红形和黑桃。 因此，通过梅花A到梅花K是1到13，通过钻石A到钻石K是14到26,红心A到红心K是1到13，黑桃A到黑桃K是14到26。这样便可以把输出对应的卡片转化为1到26的数字，写出数字对应的字母。（因为我们书写需要的是26个字母而不是1到52的数字，52恰好是26的两倍）

这就是如何使用Solitaire加密单个字母。 您可以使用它根据需要创建尽可能多的密钥流号码; 对每个输出字母只执行相同的六个步骤。 （不要重新安排套牌）。 请记住，每个消息字母需要一个。我知道卡片组有区域差异，具体取决于国家/地区。 一般来说，您使用哪种扑克的顺序规则或用什么规则把扑克转换为数字是无关紧要的。 重要的是发送者和接收者就规则达成一致。 如果你不一致，你们将无法沟通。

### **给Solitaire设置密钥**
在开始输入密钥流之前，您必须先在牌组中设定密钥。 这可能是整个操作中最重要的部分，也是整个系统安全性所依赖的部分。 Solitaire加密的安全性是建立在密钥足够安全的基础上的。 也就是说，破解Solitaire的最简单方法是弄清楚传播者使用的密钥。 如果你没有足够好的密钥，其余的安全性都无从谈起。 以下是交换密钥的一些建议。

使用相同洗牌的套牌。 随机密钥是最好的。 其中一个通信者可以随机洗牌，然后创建另一个和之前洗好的牌组相同的洗牌顺序相同的牌组。 一个发送者和另一个接收者。 其实大多数人并不知道怎么洗牌才能随机，一组牌至少要洗六次。 并且双方应该以相同的牌组顺序保留额外的备用牌组，否则如果您犯了错误，您将永远无法解密该消息。 还要记住，密钥存在风险，只要它存在; 秘密警察可以找到牌组并复制其顺序。

### **Solitaire是真正意义上的安全**

即使敌人知道算法是如何工作的，Solitaire也是安全的。 我假定“Cryptonomicon”将是畅销书，并且副本将随处可用。 我假设美国国家安全局和其他所有人都会研究该算法，并会关注它。 我假定该算法加密的信息唯一的的秘密就是钥匙。这就是为什么保证密钥的机密性如此重要的原因。 如果你在一个安全的地方有一副牌，你应该假设敌人至少会认为你使用的是Solitaire。 如果已知任何组织正在使用该算法，则假定秘密警察维护叻一个数据库以用于破解。 即使敌人知道你正在使用该算法，Solitaire也很强大，而且一套简单的扑克牌比你手上的电脑看起来更“无害”。

### **关于操作的注意事项**

1.输出反馈模式流密码的第一个规则，对任何这种密码都适用，就是你永远不应该使用相同的密钥来加密两个不同的消息。 在我之后重复：永远不要使用相同的密钥来加密两个不同的消息。 如果这样做，则会完全破坏系统的安全性。 原因如下：如果你有两个密文流，A + K和B + K，你从另一个中减去一个，你得到（A + K） - （B + K）= A + K-B-K = A-B。 这是两个明文流相互结合而没有密钥，很容易破解。 请相信我：你可能无法从A-B中恢复A和B，但是专业的密码分析专家可以。 这非常重要：永远不要使用相同的密钥来加密两个不同的消息。

2.尽可能的让信息更短。 该算法设计用于加密小的简短的信息：最多几千个字符。 在邮件中使用速记，缩写和俚语。 不要长篇大论。 如果你必须加密一个10万字的小说，请使用计算机算法。

3.像所有输出反馈流密码一样，该系统具有永远不会从错误中恢复的不幸特征。 如果您正在加密消息，并且您在其中一个操作中出错，那么之后的每个字母都将被加密错误。 即使使用密钥，您也无法对其进行解密。 你永远不会知道该条消息的明文。 因此，如果您正在加密信息，请重复加密过程两次以确保他们一致。 如果您正在解密，请检查以确保在解密时该消息有意义。 如果您从随机套牌中进行操作，请保留排序好的套牌（也就是密钥）的副本，即准备两幅顺序一致的牌组方便纠错。

4.Solitaire是可逆的。 这意味着，如果您在加密信息后后离开了你的卡组，秘密警察可以找到它并使用牌组反向运算算法。 此过程可以恢复所有输出卡并解密消息。 完成加密消息后，重要的是将套牌完全洗牌六次。(结合之前的提示，一把密钥只加密一次使用不重复使用，因此加密以后确认无误以后打乱顺序)

5.为了最大限度地保证安全，请尽量掌握所有操作。 如果秘密警察开始打破你的门，只需要平静地洗牌。 （不要把它扔到空中;你会惊讶地发现在52张散落的牌会保留很多原来的顺序）如果你有备用牌，也要记得要洗牌六次。

6.过程中如果需要写下什么，记得销毁那张纸。
烧毁可能是可用的最佳数据破坏方法，但请考虑一下这篇论文。毫无疑问，米卷纸看起来非常适合这个角色。这种纸张燃烧非常充分，而且可以吃。

在米卷纸上书写并没有你现象的那么困难。使用2号铅笔就可以了，3号铅笔效果更好，但携带起来有点奇怪。钢笔有很多问题。首先，笔的极硬尖端可能在纸张下方的表面留下印痕。此外，任何有墨水的东西都有可能渗透到纸张下面的表面。

这种纸也非常薄。 这些三英寸方形纸可折叠六次成1cm见方，厚约1mm。 一张纸可以舒适地容纳80个字母8行，每行两个写十个字，刚好容纳两个五个字母的组。 一个写的相当仔细的人可以写120字。

### **安全分析**
* [Properties of the Transformation Semigroup of the Solitaire Stream Cipher (B. Pogorelov and M. Pudovkina) ](https://eprint.iacr.org/2003/169)
* [Problems with Bruce Schneier's "Solitaire" (Paul Crowley) ](http://www.ciphergoth.org/crypto/solitaire/)
* [Probabilistic Cycle Detection for Schneier's Solitaire Keystream Algorithm (W. Tounsi, B. Justus, N.C. Boulahia, F. Cuppen, and J.G. Alfaro)](https://ieeexplore.ieee.org/document/6901648/)

### **代码实现**
https://www.schneier.com/academic/solitaire/
(见页底部，含有多种程序语言的代码)
